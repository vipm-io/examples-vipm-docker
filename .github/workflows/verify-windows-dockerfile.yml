name: Verify Windows Example Dockerfile

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'examples/ni_labview_windows_container_with_vipm/**'
      - '.github/workflows/verify-windows-dockerfile.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'examples/ni_labview_windows_container_with_vipm/**'
      - '.github/workflows/verify-windows-dockerfile.yml'
  workflow_dispatch:

jobs:
  verify-ni-labview-windows-container:
    name: Verify NI LabVIEW Windows Container Example
    runs-on: windows-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env file for testing
        working-directory: examples/ni_labview_windows_container_with_vipm
        shell: powershell
        run: |
          # Create a minimal .env file for testing
          # Using placeholder values since we're only testing the build
          @"
          VIPM_SERIAL_NUMBER=test-serial-number
          VIPM_FULL_NAME=Test User
          VIPM_EMAIL=test@example.com
          WINDOWS_VERSION=10.0.19042.1706-amd64
          "@ | Out-File -FilePath .env -Encoding utf8
          Write-Host "[OK] Created .env file for testing"

      - name: Build Docker image
        working-directory: examples/ni_labview_windows_container_with_vipm
        shell: powershell
        run: |
          Write-Host "Building Windows Docker image..."
          Write-Host "This may take 30+ minutes for the first build..."
          docker build `
            --build-arg WINDOWS_VERSION=10.0.19042.1706-amd64 `
            -t vipm-labview-windows-test:latest .
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[OK] Docker image built successfully"
          } else {
            Write-Host "[FAIL] Docker image build failed"
            exit 1
          }

      - name: Verify VIPM installation
        shell: powershell
        run: |
          Write-Host "Testing VIPM installation..."
          docker run --rm vipm-labview-windows-test:latest `
            powershell -Command "vipm --version"
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[OK] VIPM is installed and accessible"
          } else {
            Write-Host "[FAIL] VIPM verification failed"
            exit 1
          }

      - name: Verify VIPM help command
        shell: powershell
        run: |
          Write-Host "Testing VIPM help command..."
          docker run --rm vipm-labview-windows-test:latest `
            powershell -Command "vipm help"
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[OK] VIPM help command executed successfully"
          } else {
            Write-Host "[FAIL] VIPM help command failed"
            exit 1
          }

      - name: Verify VIPM directories and configuration
        shell: powershell
        run: |
          Write-Host "Verifying VIPM directories and configuration..."
          docker run --rm vipm-labview-windows-test:latest `
            powershell -Command `
              "Test-Path 'C:\ProgramData\JKI\VIPM\Settings.ini'"
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[OK] VIPM Settings.ini exists"
          }

          docker run --rm vipm-labview-windows-test:latest `
            powershell -Command `
              "Test-Path 'C:\ProgramData\JKI\jki.conf'"
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[OK] JKI configuration file exists"
          }

          Write-Host "[OK] All VIPM directories and files verified"

      - name: Verify LabVIEW installation
        shell: powershell
        run: |
          Write-Host "Checking LabVIEW installation..."
          $lvPath = 'C:\Program Files\National Instruments\LabVIEW 2025'
          docker run --rm vipm-labview-windows-test:latest `
            powershell -Command "Test-Path '$lvPath'"
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[OK] LabVIEW 2025 installation directory exists"
          } else {
            Write-Host "[FAIL] LabVIEW installation verification failed"
            exit 1
          }

      - name: Verify LabVIEW configuration
        shell: powershell
        run: |
          Write-Host "Checking LabVIEW configuration..."
          $lvIni = 'C:\Program Files\National Instruments' +
            '\LabVIEW 2025\LabVIEW.ini'
          docker run --rm vipm-labview-windows-test:latest `
            powershell -Command "Test-Path '$lvIni'"
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[OK] LabVIEW.ini configuration file exists"
          } else {
            Write-Host "[FAIL] LabVIEW configuration verification failed"
            exit 1
          }

      - name: Verify NI Package Manager
        shell: powershell
        run: |
          Write-Host "Checking NI Package Manager installation..."
          docker run --rm vipm-labview-windows-test:latest `
            powershell -Command "nipkg version"
          if ($LASTEXITCODE -eq 0) {
            Write-Host "[OK] NIPM is installed and accessible"
          } else {
            Write-Host "[FAIL] NIPM verification failed"
            exit 1
          }
